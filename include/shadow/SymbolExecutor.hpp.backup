#pragma once

#include "ShadowTypes.hpp"
#include "ShadowConfig.hpp"
#include "RangeFailureExit.hpp"
#include "PartialExitRunner.hpp"
#include "core/TradeLedger.hpp"
#include "execution/ExecutionGovernor.hpp"
#include "risk/SessionGuard.hpp"
#include "symbols/MetalProfiles.hpp"
#include <vector>
#include <unordered_map>
#include <functional>
#include <iostream>
#include <cstring>

namespace shadow {

using GUITradeCallback = std::function<void(const char* symbol, const char* side, double size, double price, double pnl)>;

struct RejectionReason {
    enum class Type {
        NONE, REGIME_BLOCKED, CONFIDENCE_LOW, ATR_ZERO,
        COST_GATE_FAILED, SESSION_BLOCKED, COOLDOWN_ACTIVE, MAX_LEGS_REACHED
    };
    Type type = Type::NONE;
    double value = 0.0;
    double threshold = 0.0;
    uint64_t timestamp_ms = 0;
    
    const char* toString() const {
        switch (type) {
            case Type::NONE: return "NONE";
            case Type::REGIME_BLOCKED: return "REGIME_BLOCKED";
            case Type::CONFIDENCE_LOW: return "CONFIDENCE_LOW";
            case Type::ATR_ZERO: return "ATR_ZERO";
            case Type::COST_GATE_FAILED: return "COST_GATE_FAILED";
            case Type::SESSION_BLOCKED: return "SESSION_BLOCKED";
            case Type::COOLDOWN_ACTIVE: return "COOLDOWN_ACTIVE";
            case Type::MAX_LEGS_REACHED: return "MAX_LEGS_REACHED";
            default: return "UNKNOWN";
        }
    }
};

struct RejectionStats {
    RejectionReason last_rejection;
    uint64_t total_rejections = 0;
    void record(RejectionReason::Type type, double value, double threshold, uint64_t ts) {
        last_rejection.type = type;
        last_rejection.value = value;
        last_rejection.threshold = threshold;
        last_rejection.timestamp_ms = ts;
        total_rejections++;
    }
};

class SymbolExecutor {
public:
    SymbolExecutor(const SymbolConfig& cfg, ExecMode mode);
    void onTick(const Tick& t);
    void onSignal(const Signal& s, uint64_t ts_ms);
    void setGUICallback(GUITradeCallback cb);
    double getRealizedPnL() const;
    int getActiveLegs() const;
    void status() const;
    
private:
    SymbolConfig cfg_;
    ExecMode mode_;
    TradeLedger ledger_;
    ExecutionGovernor governor_;
    SessionGuard session_guard_;
    Metal metal_type_;
    GUITradeCallback gui_callback_;
    std::vector<Leg> legs_;
    std::unordered_map<size_t, uint64_t> leg_to_trade_;
    double realized_pnl_;
    RejectionStats rejection_stats_;
    uint64_t last_entry_ts_;
    uint32_t trades_this_hour_;
    uint64_t hour_start_ts_;
    double last_bid_;
    double last_ask_;
    double last_latency_ms_;
    double account_equity_;
    
    bool canEnter(const Signal& s, uint64_t ts_ms);
    void enterBase(Side side, double price, uint64_t ts);
    void exitAll(const char* reason, double price, uint64_t ts);
};

} // namespace shadow
