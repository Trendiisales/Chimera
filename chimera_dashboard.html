<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIMERA Execution Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0e1a;
            color: #00ff41;
            padding: 20px;
            font-size: 14px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #0f1520;
            border: 1px solid #00ff41;
            border-radius: 4px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #00ff41;
            text-shadow: 0 0 10px #00ff41;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #0f1520;
            border: 1px solid #444;
            border-radius: 4px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff0000;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #00ff41;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #0f1520;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 20px;
        }

        .card-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
            color: #00ff41;
        }

        .symbol-card {
            border-left: 4px solid #00ff41;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #222;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #888;
        }

        .metric-value {
            color: #00ff41;
            font-weight: bold;
        }

        .metric-value.red {
            color: #ff4444;
        }

        .metric-value.yellow {
            color: #ffaa00;
        }

        .metric-value.green {
            color: #00ff41;
        }

        .state-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .state-OPEN {
            background: #004400;
            color: #00ff41;
        }

        .state-IN_POSITION {
            background: #440000;
            color: #ff4444;
        }

        .regime-FAST {
            color: #00ff41;
        }

        .regime-NORMAL {
            color: #ffaa00;
        }

        .regime-DEGRADED {
            color: #ff4444;
        }

        .regime-HALT {
            color: #ff0000;
            font-weight: bold;
        }

        .blotter {
            width: 100%;
            grid-column: 1 / -1;
        }

        .blotter-table {
            width: 100%;
            border-collapse: collapse;
        }

        .blotter-table th {
            text-align: left;
            padding: 12px;
            background: #1a1f2e;
            border-bottom: 2px solid #00ff41;
            color: #00ff41;
            font-weight: bold;
        }

        .blotter-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #222;
        }

        .blotter-table tr:hover {
            background: #1a1f2e;
        }

        .side-B {
            color: #00ff41;
        }

        .side-S {
            color: #ff4444;
        }

        .pnl-positive {
            color: #00ff41;
        }

        .pnl-negative {
            color: #ff4444;
        }

        .gates {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .gate {
            padding: 8px 12px;
            background: #1a1f2e;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gate.ok {
            border-left: 3px solid #00ff41;
        }

        .gate.blocked {
            border-left: 3px solid #ff4444;
        }

        .connection-status {
            text-align: center;
            padding: 15px;
            background: #0f1520;
            border: 1px solid #444;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .reconnect-btn {
            margin-top: 10px;
            padding: 8px 20px;
            background: #00ff41;
            color: #0a0e1a;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .reconnect-btn:hover {
            background: #00cc33;
        }

        .config-panel {
            background: #0f1520;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            background: #1a1f2e;
            border: 1px solid #444;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .config-btn {
            padding: 10px 30px;
            background: #00ff41;
            color: #0a0e1a;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin-right: 10px;
        }

        .config-btn:hover {
            background: #00cc33;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ CHIMERA EXECUTION DASHBOARD ⚡</h1>
            <div id="uptime">Uptime: --:--:--</div>
        </div>

        <!-- Configuration Panel (shown when disconnected) -->
        <div id="config-panel" class="config-panel">
            <div class="card-header">WebSocket Configuration</div>
            <input type="text" id="ws-url" class="config-input" placeholder="WebSocket URL (e.g., ws://185.167.119.59:7777)">
            <button class="config-btn" onclick="connect()">Connect</button>
            <button class="config-btn" onclick="saveConfig()">Save Config</button>
            <div style="margin-top: 10px; color: #888; font-size: 12px;">
                Enter the WebSocket URL of your CHIMERA engine (default port: 7777)
            </div>
        </div>

        <!-- Connection Status -->
        <div id="connection-status" class="connection-status hidden">
            <div class="status-dot" id="status-dot"></div>
            <span id="connection-text">Disconnected</span>
            <button class="reconnect-btn hidden" id="reconnect-btn" onclick="reconnect()">Reconnect</button>
        </div>

        <!-- Main Dashboard (hidden until connected) -->
        <div id="dashboard" class="hidden">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot connected" id="ws-status"></div>
                    <span id="ws-status-text">WebSocket: Connected</span>
                </div>
                <div class="status-item">
                    <span>Latency: <span id="global-latency">--</span> ms</span>
                </div>
                <div class="status-item">
                    <span>Regime: <span id="global-regime">--</span></span>
                </div>
                <div class="status-item">
                    <span>PnL: $<span id="total-pnl">0.00</span></span>
                </div>
            </div>

            <!-- Symbol Cards -->
            <div class="grid">
                <!-- XAU Card -->
                <div class="card symbol-card">
                    <div class="card-header">XAUUSD (Gold)</div>
                    <div class="metric-row">
                        <span class="metric-label">State</span>
                        <span class="metric-value"><span id="xau-state" class="state-badge">--</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Bid / Ask</span>
                        <span class="metric-value"><span id="xau-bid">--</span> / <span id="xau-ask">--</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Spread</span>
                        <span class="metric-value" id="xau-spread">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Latency</span>
                        <span class="metric-value" id="xau-latency">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Trades / Rejects</span>
                        <span class="metric-value"><span id="xau-trades">0</span> / <span id="xau-rejects">0</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Active Legs</span>
                        <span class="metric-value" id="xau-legs">0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">PnL (Shadow)</span>
                        <span class="metric-value" id="xau-pnl">$0.00</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Edge (Raw)</span>
                        <span class="metric-value"><span id="xau-edge-raw">--</span> bps</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Impulse</span>
                        <span class="metric-value"><span id="xau-impulse">--</span></span>
                    </div>
                    <div class="gates" id="xau-gates"></div>
                </div>

                <!-- XAG Card -->
                <div class="card symbol-card">
                    <div class="card-header">XAGUSD (Silver)</div>
                    <div class="metric-row">
                        <span class="metric-label">State</span>
                        <span class="metric-value"><span id="xag-state" class="state-badge">--</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Bid / Ask</span>
                        <span class="metric-value"><span id="xag-bid">--</span> / <span id="xag-ask">--</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Spread</span>
                        <span class="metric-value" id="xag-spread">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Latency</span>
                        <span class="metric-value" id="xag-latency">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Trades / Rejects</span>
                        <span class="metric-value"><span id="xag-trades">0</span> / <span id="xag-rejects">0</span></span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Active Legs</span>
                        <span class="metric-value" id="xag-legs">0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">PnL (Shadow)</span>
                        <span class="metric-value" id="xag-pnl">$0.00</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Edge (Raw)</span>
                        <span class="metric-value"><span id="xag-edge-raw">--</span> bps</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Impulse</span>
                        <span class="metric-value"><span id="xag-impulse">--</span></span>
                    </div>
                    <div class="gates" id="xag-gates"></div>
                </div>
            </div>

            <!-- Trade Blotter -->
            <div class="card blotter">
                <div class="card-header">Trade Blotter</div>
                <table class="blotter-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>Fees</th>
                            <th>PnL</th>
                        </tr>
                    </thead>
                    <tbody id="blotter-body">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #888;">No trades yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectInterval = null;
        let wsUrl = localStorage.getItem('chimera_ws_url') || '';

        // Load saved config on startup
        window.addEventListener('load', () => {
            if (wsUrl) {
                document.getElementById('ws-url').value = wsUrl;
                connect();
            }
        });

        function saveConfig() {
            const url = document.getElementById('ws-url').value.trim();
            if (url) {
                localStorage.setItem('chimera_ws_url', url);
                alert('Configuration saved!');
            }
        }

        function connect() {
            const url = document.getElementById('ws-url').value.trim();
            if (!url) {
                alert('Please enter a WebSocket URL');
                return;
            }

            wsUrl = url;
            localStorage.setItem('chimera_ws_url', url);

            // Show connection status, hide config
            document.getElementById('config-panel').classList.add('hidden');
            document.getElementById('connection-status').classList.remove('hidden');
            document.getElementById('connection-text').textContent = 'Connecting...';

            if (ws) {
                ws.close();
            }

            ws = new WebSocket(url);

            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('connection-text').textContent = 'Connected';
                document.getElementById('reconnect-btn').classList.add('hidden');
                document.getElementById('connection-status').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateDashboard(data);
                } catch (e) {
                    console.error('Failed to parse JSON:', e);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('status-dot').classList.remove('connected');
                document.getElementById('connection-text').textContent = 'Disconnected - Attempting to reconnect...';
                document.getElementById('reconnect-btn').classList.remove('hidden');
                document.getElementById('connection-status').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                
                // Auto-reconnect every 5 seconds
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(() => {
                        console.log('Attempting to reconnect...');
                        connect();
                    }, 5000);
                }
            };
        }

        function reconnect() {
            connect();
        }

        function updateDashboard(data) {
            // Update uptime
            if (data.meta && data.meta.uptime) {
                document.getElementById('uptime').textContent = `Uptime: ${data.meta.uptime}`;
            }

            // Update global status
            if (data.latency) {
                document.getElementById('global-latency').textContent = data.latency.fix_rtt_ms.toFixed(2);
                const regimeEl = document.getElementById('global-regime');
                regimeEl.textContent = data.latency.regime;
                regimeEl.className = `regime-${data.latency.regime}`;
            }

            // Update total PnL
            if (data.exec) {
                const pnl = data.exec.pnl;
                const pnlEl = document.getElementById('total-pnl');
                pnlEl.textContent = pnl.toFixed(2);
                pnlEl.className = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
            }

            // Update XAU
            if (data.xau) {
                updateSymbol('xau', data.xau);
            }

            // Update XAG
            if (data.xag) {
                updateSymbol('xag', data.xag);
            }

            // Update blotter
            if (data.blotter) {
                updateBlotter(data.blotter);
            }
        }

        function updateSymbol(prefix, sym) {
            // State
            const stateEl = document.getElementById(`${prefix}-state`);
            stateEl.textContent = sym.state;
            stateEl.className = `state-badge state-${sym.state}`;

            // Prices
            document.getElementById(`${prefix}-bid`).textContent = sym.bid.toFixed(2);
            document.getElementById(`${prefix}-ask`).textContent = sym.ask.toFixed(2);

            // Spread
            const spreadEl = document.getElementById(`${prefix}-spread`);
            spreadEl.textContent = sym.spread.toFixed(3);
            spreadEl.className = sym.spread < (prefix === 'xau' ? 0.50 : 0.05) ? 'metric-value green' : 'metric-value red';

            // Latency
            const latencyEl = document.getElementById(`${prefix}-latency`);
            latencyEl.textContent = `${sym.latency_ms.toFixed(2)} ms (${sym.regime})`;
            latencyEl.className = sym.latency_ms < 8.0 ? 'metric-value green' : 'metric-value red';

            // Trades/Rejects
            document.getElementById(`${prefix}-trades`).textContent = sym.trades;
            document.getElementById(`${prefix}-rejects`).textContent = sym.rejects;

            // Legs
            document.getElementById(`${prefix}-legs`).textContent = sym.legs;

            // PnL
            const pnlEl = document.getElementById(`${prefix}-pnl`);
            pnlEl.textContent = `$${sym.pnl.shadow.toFixed(2)}`;
            pnlEl.className = sym.pnl.shadow >= 0 ? 'metric-value green' : 'metric-value red';

            // Edge
            document.getElementById(`${prefix}-edge-raw`).textContent = sym.edge.raw.toFixed(1);

            // Impulse
            const impulseEl = document.getElementById(`${prefix}-impulse`);
            impulseEl.textContent = `${sym.impulse.latency_adj.toFixed(2)} / ${sym.impulse.min.toFixed(2)}`;
            impulseEl.className = sym.impulse.latency_adj >= sym.impulse.min ? 'metric-value green' : 'metric-value red';

            // Gates
            if (sym.gates) {
                const gatesContainer = document.getElementById(`${prefix}-gates`);
                gatesContainer.innerHTML = '';
                for (const [name, gate] of Object.entries(sym.gates)) {
                    const gateDiv = document.createElement('div');
                    gateDiv.className = `gate ${gate.ok ? 'ok' : 'blocked'}`;
                    gateDiv.innerHTML = `
                        <span>${name.toUpperCase()}</span>
                        <span>${gate.ok ? '✓' : '✗'} ${gate.reason}</span>
                    `;
                    gatesContainer.appendChild(gateDiv);
                }
            }
        }

        function updateBlotter(trades) {
            const tbody = document.getElementById('blotter-body');
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #888;">No trades yet</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            trades.forEach(trade => {
                const row = document.createElement('tr');
                const pnlClass = trade.pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const sideClass = trade.side === 'B' ? 'side-B' : 'side-S';
                
                row.innerHTML = `
                    <td>${trade.id}</td>
                    <td>${trade.sym}</td>
                    <td class="${sideClass}">${trade.side}</td>
                    <td>${trade.qty.toFixed(2)}</td>
                    <td>${trade.entry.toFixed(2)}</td>
                    <td>${trade.exit.toFixed(2)}</td>
                    <td>$${trade.fees.toFixed(2)}</td>
                    <td class="${pnlClass}">$${trade.pnl.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
